<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ¢µé«˜çš„ä¸–ç•Œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        
        #video-container {
            position: relative;
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
        }

        video { width: 100%; height: 100%; object-fit: cover; }

        .camera-preview {
            position: absolute; bottom: 20px; right: 20px;
            width: 200px; height: 150px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px; opacity: 0.7;
            transform: scaleX(-1); z-index: 10;
        }
        #outputCanvas { width: 100%; height: 100%; }
        #inputVideo { display: none; }

        #guide {
            position: absolute; top: 20px; left: 20px;
            color: rgba(255, 255, 255, 0.6); font-size: 16px; z-index: 10; pointer-events: none;
            background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px;
        }

        /* çœ¨çœ¼ç‰¹æ•ˆ */
        .eyelid {
            position: fixed; left: 0; width: 100%; height: 0%;
            background: #000; z-index: 100; transition: height 0.3s ease-in-out;
        }
        #lid-top { top: 0; }
        #lid-bottom { bottom: 0; }
        .blink #lid-top, .blink #lid-bottom { height: 51%; }
    </style>
</head>
<body>

    <div id="guide">
        ğŸ–ï¸ <b>æ¨æ‹‰æ§åˆ¶ï¼š</b> å¹³ç¨³å‰åç§»åŠ¨æ‰‹æŒ<br>
        ğŸ‘Œ <b>æåˆæ‰‹æŒ‡ï¼š</b> åˆ‡æ¢è§†é¢‘<br>
        <span id="debug-info" style="font-size:12px; color:#aaa">ç­‰å¾…æ‰‹åŠ¿...</span>
    </div>

    <div id="lid-top" class="eyelid"></div>
    <div id="lid-bottom" class="eyelid"></div>

    <div id="video-container">
        <video id="mainVideo" playsinline>
            <source src="video1.mp4" type="video/mp4">
        </video>
    </div>

    <div class="camera-preview">
        <video id="inputVideo"></video>
        <canvas id="outputCanvas"></canvas>
    </div>

<script>
    const videoList = ['video1.mp4', 'video2.mp4', 'video3.mp4'];
    let currentVideoIndex = 0;
    
    const videoElement = document.getElementById('inputVideo');
    const canvasElement = document.getElementById('outputCanvas');
    const canvasCtx = canvasElement.getContext('2d');
    const mainVideo = document.getElementById('mainVideo');
    const debugInfo = document.getElementById('debug-info');
    
    // --- æ ¸å¿ƒå‚æ•°é…ç½® ---
    // çµæ•åº¦ï¼šå€¼è¶Šå°ï¼Œè§†é¢‘åŠ¨å¾—è¶Šæ…¢ã€‚ä¹‹å‰æ˜¯80å¤ªå¿«äº†ï¼Œç°åœ¨é™åˆ°30ã€‚
    const SENSITIVITY = 30; 
    
    // å¹³æ»‘ç³»æ•° (0.0 - 1.0)ï¼šå€¼è¶Šå°è¶Šå¹³æ»‘ï¼Œä½†å»¶è¿Ÿè¶Šé«˜ã€‚0.1 æ˜¯ä¸€ä¸ªå¾ˆç¨³çš„å€¼ã€‚
    const SMOOTHING_FACTOR = 0.1; 
    
    // æ­»åŒºé˜ˆå€¼ï¼šå¦‚æœè®¡ç®—å‡ºçš„æ—¶é—´å˜åŒ–å°äºè¿™ä¸ªå€¼ï¼ˆç§’ï¼‰ï¼Œåˆ™å¿½ç•¥ä¸è®¡ã€‚é˜²æ­¢æ‰‹æŠ–å¯¼è‡´è§†é¢‘å¾®é¢¤ã€‚
    const DEAD_ZONE = 0.08; 

    // --- çŠ¶æ€å˜é‡ ---
    let smoothedHandSize = 0; // ç»è¿‡å¹³æ»‘å¤„ç†çš„æ‰‹æŒå¤§å°
    let isHandPresent = false;
    let isPinching = false;
    let isTransitioning = false;

    // çº¿æ€§æ’å€¼å‡½æ•° (Lerp) - å®ç°å¹³æ»‘çš„å…³é”®
    function lerp(start, end, amt) {
        return (1 - amt) * start + amt * end;
    }

    function onResults(results) {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            
            // ç»˜åˆ¶éª¨æ¶
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1});

            handlePinch(landmarks);

            if (!isTransitioning) {
                handleSmoothedScrubbing(landmarks);
            }
            isHandPresent = true;
        } else {
            isHandPresent = false;
            // æ‰‹ç¦»å¼€æ—¶é‡ç½®å¹³æ»‘å€¼ï¼Œä¸‹æ¬¡æ‰‹è¿›æ¥æ—¶é‡æ–°åˆå§‹åŒ–ï¼Œé˜²æ­¢è·³å˜
            smoothedHandSize = 0; 
        }
        canvasCtx.restore();
    }

    // è®¡ç®—ä¸¤ç‚¹è·ç¦»
    function getDistance(p1, p2) {
        return Math.hypot(p1.x - p2.x, p1.y - p2.y);
    }

    // å¤„ç†æåˆåˆ‡æ¢
    function handlePinch(landmarks) {
        const thumbTip = landmarks[4];
        const indexTip = landmarks[8];
        const distance = getDistance(thumbTip, indexTip);

        if (distance < 0.05) {
            if (!isPinching && !isTransitioning) {
                isPinching = true;
                triggerBlinkTransition();
            }
        } else {
            isPinching = false;
        }
    }

    // çœ¨çœ¼è½¬åœº
    function triggerBlinkTransition() {
        isTransitioning = true;
        document.body.classList.add('blink');
        setTimeout(() => {
            currentVideoIndex = (currentVideoIndex + 1) % videoList.length;
            mainVideo.src = videoList[currentVideoIndex];
            smoothedHandSize = 0; // åˆ‡æ¢è§†é¢‘åé‡ç½®æ‰‹åŠ¿çŠ¶æ€
            setTimeout(() => {
                document.body.classList.remove('blink');
                isTransitioning = false;
            }, 200);
        }, 300);
    }

    // --- æ ¸å¿ƒä¼˜åŒ–ï¼šå¹³æ»‘æ¨æ‹‰é€»è¾‘ ---
    function handleSmoothedScrubbing(landmarks) {
        const wrist = landmarks[0];
        const middleTip = landmarks[12];
        
        // 1. è·å–å½“å‰å¸§çš„åŸå§‹å¤§å°
        const rawHandSize = getDistance(wrist, middleTip);

        // 2. åˆå§‹åŒ–ï¼šå¦‚æœè¿™æ˜¯æ‰‹åˆšå‡ºç°çš„ç¬¬ä¸€å¸§ï¼Œç›´æ¥å¯¹é½ï¼Œä¸è¦å¹³æ»‘è¿‡æ¸¡
        if (smoothedHandSize === 0) {
            smoothedHandSize = rawHandSize;
            return;
        }

        // 3. åº”ç”¨å¹³æ»‘ç®—æ³•ï¼šå½“å‰å¹³æ»‘å€¼å‘ç›®æ ‡å€¼ï¼ˆåŸå§‹å€¼ï¼‰ç§»åŠ¨ä¸€å°æ­¥
        // è¿™æ ·å³ä½¿ rawHandSize åœ¨å‰§çƒˆæŠ–åŠ¨ï¼ŒsmoothedHandSize ä¹Ÿä¼šå˜åŒ–å¾—å¾ˆåœ†æ¶¦
        smoothedHandSize = lerp(smoothedHandSize, rawHandSize, SMOOTHING_FACTOR);

        // 4. è®¡ç®—ç›¸å¯¹äºä¸Šä¸€å¸§çš„å˜åŒ–é‡ (Delta)
        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æ¯”è¾ƒçš„æ˜¯ "å½“å‰å¹³æ»‘å€¼" å’Œ "ç›®æ ‡åŸå§‹å€¼" ä¹‹é—´çš„è¶‹åŠ¿ï¼Œ
        // æˆ–è€…æ›´ç®€å•ï¼šæˆ‘ä»¬è®°å½•ä¸Šä¸€å¸§çš„å¹³æ»‘å€¼ã€‚
        // ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬è¿™é‡Œé€šè¿‡æ¯”è¾ƒ (Smoothed - PreviousSmoothed) æ¥é©±åŠ¨
        // ä½†ç”±äº lerp çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ä¸€ä¸ªä¸´æ—¶å˜é‡å­˜å‚¨ä¸Šä¸€å¸§çš„çŠ¶æ€
        // è¿™é‡Œåšä¸€ä¸ªç®€åŒ–çš„ Delta è®¡ç®—ï¼š
        
        // é‡æ–°è®¾è®¡ Delta é€»è¾‘ï¼š
        // æˆ‘ä»¬éœ€è¦ç”± "æ‰‹çš„å¤§å°å˜åŒ–" é©±åŠ¨ "æ—¶é—´å˜åŒ–"ã€‚
        // ä¸ºäº†é¿å…ç´¯ç§¯è¯¯å·®ï¼Œæˆ‘ä»¬æ¯”è¾ƒ "æœ¬å¸§å¹³æ»‘åçš„å¤§å°" ä¸ "ä¸Šä¸€å¸§å¹³æ»‘åçš„å¤§å°"
        // ä½†ç”±äº JS é—­åŒ…ç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å‡½æ•°å¤–å­˜å‚¨ prevSmoothedHandSize
        // ä¸‹é¢æ˜¯ä¿®æ­£åçš„é€»è¾‘ï¼š
    }

    // ä¿®æ­£åçš„å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨ä¸Šä¸€å¸§çŠ¶æ€
    let prevSmoothedSize = 0;

    // è¦†ç›–ä¸Šé¢çš„å‡½æ•°
    function handleSmoothedScrubbing(landmarks) {
        const wrist = landmarks[0];
        const middleTip = landmarks[12];
        const rawHandSize = getDistance(wrist, middleTip);

        // åˆå§‹åŒ–
        if (prevSmoothedSize === 0) {
            prevSmoothedSize = rawHandSize;
            return;
        }

        // è®¡ç®—å¹³æ»‘åçš„å½“å‰å¤§å°
        const currentSmoothedSize = lerp(prevSmoothedSize, rawHandSize, SMOOTHING_FACTOR);

        // è®¡ç®—å˜åŒ–é‡ (Delta)
        const delta = currentSmoothedSize - prevSmoothedSize;

        // æ›´æ–°ä¸Šä¸€å¸§è®°å½•
        prevSmoothedSize = currentSmoothedSize;

        // --- é˜²æŠ–å¤„ç† (Dead Zone) ---
        // è®¡ç®—åŸæœ¬åº”è¯¥æ”¹å˜çš„æ—¶é—´é‡
        let timeDelta = delta * SENSITIVITY;

        // åªæœ‰å½“æ—¶é—´å˜åŒ–é‡è¶…è¿‡ä¸€å®šé˜ˆå€¼ï¼Œæ‰çœŸæ­£åº”ç”¨åˆ°è§†é¢‘
        // è¿™æ¶ˆé™¤äº†å¾®å°çš„æ‰‹æŠ–
        if (Math.abs(timeDelta) < DEAD_ZONE) {
            timeDelta = 0;
            debugInfo.innerText = "çŠ¶æ€: é™æ­¢ (é˜²æŠ–ä¸­)";
        } else {
            debugInfo.innerText = `çŠ¶æ€: ${timeDelta > 0 ? "â© å‰è¿›" : "âª åé€€"} | åŠ›åº¦: ${Math.abs(timeDelta).toFixed(2)}`;
        }

        if (timeDelta !== 0) {
            let newTime = mainVideo.currentTime + timeDelta;
            // è¾¹ç•Œé™åˆ¶
            if (newTime < 0) newTime = 0;
            if (newTime > mainVideo.duration) newTime = mainVideo.duration;
            
            mainVideo.currentTime = newTime;
        }
    }

    // MediaPipe Setup
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 320, height: 180
    });
    camera.start();

</script>

</body>
</html>